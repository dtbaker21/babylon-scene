<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Babylon Scene</title>
  <style>
    html, body { margin: 0; padding: 0; overflow: hidden; }
    canvas { width: 100%; height: 100%; display: block; }
  </style>
  <script src="https://cdn.babylonjs.com/babylon.js"></script>
  <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
</head>
<body>
  <canvas id="renderCanvas"></canvas>
  <script>
    const canvas = document.getElementById("renderCanvas");
    const engine = new BABYLON.Engine(canvas, true);

var createScene = function () {
    var scene = new BABYLON.Scene(engine);

    //----CAMERA SETUP-----------------------
    var camera = new BABYLON.ArcRotateCamera("Camera", -Math.PI, Math.PI / 2, 6, BABYLON.Vector3(0, 0, 0), scene);
    camera.attachControl(canvas, true);
    camera.wheelPrecision = 40;
    camera.setTarget(new BABYLON.Vector3(0, 0.3, 0));
    camera.panningSensibility = 0;
    camera.pinchDeltaPercentage = 0.001;
    camera.fov = 0.3;
    camera.beta = 1.2;
    camera.alpha = 0.8;
    camera.upperBetaLimit = 1.55;
    camera.upperRadiusLimit = 10;
    camera.lowerRadiusLimit = 1.7;

    //----RENDERING PIPELINE + BLOOM---------
    var pipeline = new BABYLON.DefaultRenderingPipeline("defaultPipeline", true, scene, [camera]);
    pipeline.fxaaEnabled = true;
    pipeline.samples = 4;
    pipeline.imageProcessing.contrast = 2.2;
    pipeline.imageProcessing.exposure = 0.8;

    pipeline.bloomEnabled = true;
    pipeline.bloomThreshold = 0.3;
    pipeline.bloomIntensity = 2.0;
    pipeline.bloomKernel = 128;

    //----HDRI TEXTURE------------------------
    var hdrTexture = BABYLON.CubeTexture.CreateFromPrefilteredData("textures/Studio_Softbox_2Umbrellas_cube_specular.env", scene);
    hdrTexture.level = 0.5;
    scene.environmentTexture = hdrTexture;

    //----CINEMATIC LIGHTING------------------
    var keyLight = new BABYLON.SpotLight("keyLight", new BABYLON.Vector3(2, 2.5, -2), new BABYLON.Vector3(-0.5, -1, 0.5), Math.PI / 4, 20, scene);
    keyLight.diffuse = new BABYLON.Color3(1, 0.75, 0.5);
    keyLight.specular = new BABYLON.Color3(1, 0.75, 0.5);
    keyLight.intensity = 0.9;

    var rimLight = new BABYLON.DirectionalLight("rimLight", new BABYLON.Vector3(0, -0.8, -1), scene);
    rimLight.position = new BABYLON.Vector3(0, 3, 4);
    rimLight.diffuse = new BABYLON.Color3(0.3, 0.5, 1);
    rimLight.specular = new BABYLON.Color3(0.8, 0.9, 1);
    rimLight.intensity = 3.5;

    var fillLight = new BABYLON.DirectionalLight("fillLight", new BABYLON.Vector3(-1, -0.5, 0.5), scene);
    fillLight.diffuse = new BABYLON.Color3(0.4, 0.5, 0.8);
    fillLight.specular = new BABYLON.Color3(0.4, 0.5, 0.8);
    fillLight.intensity = 0.3;

    //----GLOW LAYER FOR EDGE BLOOM----------
    const glowLayer = new BABYLON.GlowLayer("glow", scene);
    glowLayer.intensity = 0.4;
    glowLayer.blurKernelSize = 64;
    glowLayer.glowColor = new BABYLON.Color3(0.4, 0.6, 1);

    //----TRANSPARENT BACKGROUND & SHADOW CATCHER-----
    scene.clearColor = new BABYLON.Color4(0, 0, 0, 0);

    const groundPlane = BABYLON.MeshBuilder.CreateGround("ground", { height: 100, width: 100 }, scene);
    groundPlane.position.y = -0.01;
    groundPlane.isPickable = false;
    groundPlane.isVisible = true;

    const shadowMat = new BABYLON.ShadowOnlyMaterial("shadowMat", scene);
    shadowMat.alpha = 0.6;
    shadowMat.shadowColor = new BABYLON.Color3(0, 0, 0);
    groundPlane.material = shadowMat;

    const shadowGenerator = new BABYLON.ShadowGenerator(2048, keyLight);
    shadowGenerator.useBlurExponentialShadowMap = true;
    shadowGenerator.blurKernel = 32;
    shadowGenerator.depthScale = 100;
    shadowGenerator.setDarkness(0.5);

    //----PRODUCT MESH------------------------
    BABYLON.SceneLoader.ImportMesh("", "https://dl.dropbox.com/s/ik9xxhdkio6g8qu/B07QPQCQKQ.glb", "my-file.glb", scene, function (mesh) {
        const meshConstant = scene.getMeshByName("__root__");
        meshConstant.position.y = 0.01;

        const couchMat = new BABYLON.StandardMaterial("couchMat", scene);
        couchMat.diffuseColor = new BABYLON.Color3(0.1, 0.1, 0.1);
        couchMat.emissiveColor = new BABYLON.Color3(0.4, 0.6, 1);
        meshConstant.material = couchMat;

        glowLayer.addIncludedOnlyMesh(meshConstant);

        // Add shadow caster
        shadowGenerator.addShadowCaster(meshConstant);

        // ---- CAMERA ANIMATIONS ----
        var animationAlpha = new BABYLON.Animation("cameraAlphaAnimation", "alpha", 30,
            BABYLON.Animation.ANIMATIONTYPE_FLOAT, BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT);

        var alphaKeys = [
            { frame: 0, value: camera.alpha },
            { frame: 120, value: camera.alpha + (1) }
        ];
        animationAlpha.setKeys(alphaKeys);

        var easingAlpha = new BABYLON.CubicEase();
        easingAlpha.setEasingMode(BABYLON.EasingFunction.EASINGMODE_EASEINOUT);
        animationAlpha.setEasingFunction(easingAlpha);

        var animationBeta = new BABYLON.Animation("cameraBetaAnimation", "beta", 30,
            BABYLON.Animation.ANIMATIONTYPE_FLOAT, BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT);

        var betaKeys = [
            { frame: 0, value: camera.beta },
            { frame: 120, value: camera.beta + 0.2 }
        ];
        animationBeta.setKeys(betaKeys);

        var easingBeta = new BABYLON.CubicEase();
        easingBeta.setEasingMode(BABYLON.EasingFunction.EASINGMODE_EASEINOUT);
        animationBeta.setEasingFunction(easingBeta);

        var group = new BABYLON.AnimationGroup("cameraGroup");
        group.addTargetedAnimation(animationAlpha, camera);
        group.addTargetedAnimation(animationBeta, camera);
        group.play(false);
    });

    //----INLINE SHADER FOR FADE-IN (Option 2)---------------
    BABYLON.Effect.ShadersStore["fadeFragmentShader"] = `
        precision highp float;
        varying vec2 vUV;
        uniform sampler2D textureSampler;
        uniform float fadeLevel;
        void main(void) {
            vec4 color = texture2D(textureSampler, vUV);
            gl_FragColor = vec4(color.rgb, color.a * fadeLevel);
        }
    `;

    // Start at 0% opacity
    scene.fadeLevel = 0.0;

    const fadePostProcess = new BABYLON.PostProcess(
        "Fade",
        "fade",                // shader name
        ["fadeLevel"],         // uniforms
        null,
        1.0,
        camera
    );

    fadePostProcess.onApply = (effect) => {
        effect.setFloat("fadeLevel", scene.fadeLevel);
    };

    // Animate fadeLevel from 0 â†’ 1 over 120 frames
    var fadeAnim = new BABYLON.Animation("fadeAnim", "fadeLevel", 30,
        BABYLON.Animation.ANIMATIONTYPE_FLOAT, BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT);

    fadeAnim.setKeys([
        { frame: 0, value: 0.0 },   // true 0% opacity
        { frame: 120, value: 1.0 }  // fully visible
    ]);

    var easingFade = new BABYLON.CubicEase();
    easingFade.setEasingMode(BABYLON.EasingFunction.EASINGMODE_EASEINOUT);
    fadeAnim.setEasingFunction(easingFade);

    scene.animations.push(fadeAnim);
    scene.beginAnimation(scene, 0, 120, false);

    return scene;
};



    const scene = createScene();
    engine.runRenderLoop(() => scene.render());
    window.addEventListener("resize", () => engine.resize());
  </script>
</body>
</html>
